# Web 版本说明（含 Canvas 渲染、设置面板与持久化）

> 本文件逐行使用中文描述，介绍如何在浏览器端运行 2048 关卡版，并说明设置面板、URL 覆盖以及导入/导出流程。

## 打开方法
1. 直接双击 `index.html` 或使用本地静态服务器访问 `web/index.html`，即可在浏览器中体验关卡模式。
2. 游戏支持键盘方向键与触摸滑动操作，桌面端与移动端均可完成数字合并。
3. 页面会自动读取本地存储中的设置与进度，刷新后仍可从上次关卡继续。

## 设置面板
- 画布下方新增“设置与持久化”面板，可调整画布尺寸、格子间隙、起始尺寸、是否累计总分以及目标函数（`power` 或示例 `fibonacci`）。
- 额外提供「起始种子」与「启用动画」开关，允许玩家固定随机序列与控制淡入效果。
- 修改任意字段会立即写入 `localStorage`（`stage2048.settings.v2`），并基于新配置重新初始化关卡。
- 面板底部提供“导出设置/进度（JSON）”与“导入设置/进度（选择文件）”按钮，可用于备份或迁移数据。

## URL 覆盖
- 地址栏追加查询参数即可覆盖本地存储中的配置，例如：`index.html?size=3&gap=8&targetFnKey=power`。
- 优先级为：URL Query → 本地存储 → 默认配置。

## 导入 / 导出流程
1. 点击“导出设置/进度（JSON）”会生成包含 `{ settings, progress, bestScore, replay }` 的文本文件，其中 `replay` 内含 `{ seed, ops }`。
2. 点击“导入设置/进度（选择文件）”并选择上述文件，可恢复设置、关卡进度与最佳分。
3. 导入成功后会覆盖本地存储，并自动重绘当前棋盘。

## 撤销与复盘
- “撤销一步”按钮会恢复到上一次成功移动前的关卡状态，并清空本地撤销记录，确保不会连续倒退多步。
- 导出的 JSON 附带 `ops` 操作序列；导入时若识别到 `replay` 字段，会自动按序重放并在结束时同步 HUD。
- 固定种子搭配操作序列可实现跨设备复盘，导入时会在状态栏给出进度提示。

## 演示模式
- “演示模式”复选框启用后，脚本会每隔约 160ms 尝试「左→上→右→下」四个方向，寻找第一个可行移动。
- 当棋盘无法再移动或玩家关闭开关时，演示模式会立即停止并在状态区播报。
- 演示过程中依然会记录操作序列，但导出时会标记来源，方便玩家区分手动与演示步骤。

## 动画与性能
- “启用动画”打开后，新生成或合并的方块会通过透明度渐变淡入，大约 160ms 内完成。
- 动画状态使用 `requestAnimationFrame` 驱动，并在绘制完成后自动清理，避免积累无效帧。
- 绘制函数加入 `requestAnimationFrame` 合帧节流，可将密集输入合并为单帧渲染，降低抖动。
- 若设备性能较低，可保持默认关闭状态以获得最稳定的帧率。

## 可访问性与状态提示
- HUD 元素与按钮均设置了 `aria-label`/`aria-live`，屏幕阅读器可朗读得分、总分与关卡变化。
- 高对比度开关会在 `<body>` 上附加 `high-contrast` 类名，并启用 `/web/a11y.css` 中的焦点高亮与色彩增强。
- 页面底部的隐藏 `#status` 区域通过 `role="status"` 播报导入、导出、重置等操作结果。

## 性能提示
- 若需要在低端设备上测试，请保持“启用动画”关闭，并利用 URL Query 限制棋盘尺寸（如 `?size=3`）。
- 触摸与键盘事件均经过合帧处理，可避免因快速操作导致的重复绘制。
- 导出 JSON 时会同步记录操作序列，可用于后续离线复盘或性能回放分析。

## 成就系统
- 页面会追踪历史最大方块值（存储于 `stage2048.maxTile.v1`），并在 HUD 下方展示 🗝️、🎯、🏆 等徽章。
- 徽章区域设置了 `aria-label`，屏幕阅读器会朗读当前已解锁的成就描述。
- 撤销、复盘或演示模式都不会影响已解锁的徽章；只有在创造更高方块时才会追加记录。

## 重置与清空
- “重置进度”按钮会删除本地存档，并按当前设置重新开始游戏。
- “清空最佳分”按钮会清除历史最佳成绩，并立即刷新 HUD。

## 故障排查
- 若发现画布模糊，请检查系统缩放比例与设备像素比；窗口大小变化时脚本会自动重算画布尺寸。
- 若导入失败，请确认 JSON 结构与示例一致，并检查浏览器控制台输出的报错信息。
