# 关卡包使用指南

本文档说明 Stage2048 新增的“关卡包”功能：通过 JSON 文件定义一组连续关卡参数，导入后即可按预设顺序推进游戏。

## JSON 格式概览

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `name` | `string` | 关卡包名称，可选，用于提示区域展示。 |
| `version` | `number` | 关卡包版本号，可选，缺省为 `1`。 |
| `levels` | `array` | **必填**，按顺序列出每一关的配置。 |

每个 `levels[i]` 对象支持以下字段：

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `size` | `number` | **必填**，棋盘尺寸，范围 2~10 的整数。 |
| `targetFnKey` | `string` | 可选，目标函数标识，例如 `power` 或 `fibonacci`。缺省沿用当前设置。 |
| `randomTileWeights` | `object` | 可选，本关新生权重，键为方块数值，值为概率（`(0,1]`），总和需接近 `1`（容差 ±0.001）。 |

## 示例配置

```json
{
  "//": "示例关卡包：演示三关的基本配置",
  "name": "示例入门包",
  "version": 1,
  "levels": [
    {
      "//": "第 1 关：2×2 棋盘，新生只会生成 1",
      "size": 2,
      "randomTileWeights": { "1": 1.0 }
    },
    {
      "//": "第 2 关：3×3 棋盘，新生以 1 为主，偶尔生成 2",
      "size": 3,
      "randomTileWeights": { "1": 0.9, "2": 0.1 }
    },
    {
      "//": "第 3 关：4×4 棋盘，目标函数保持 power，新生以 2 与 4 为主",
      "size": 4,
      "targetFnKey": "power",
      "randomTileWeights": { "2": 0.9, "4": 0.1 }
    }
  ]
}
```

该示例已收录在 `web/packs/sample-pack.json`，可直接导入体验。

## 校验规则

* `levels` 必须是非空数组。
* 每个关卡的 `size` 需满足 2~10 的整数。
* 若提供 `randomTileWeights`，各项概率需落在 `(0,1]`，并且总和与 1 的误差不超过 `0.001`。
* 若提供 `targetFnKey`，必须是注册表支持的键（默认包含 `power` 与 `fibonacci`）。
* 读取失败或结构无效时，会给出提示并忽略该关卡包，不影响游戏正常运行。

## 导入与清除

### Web 端

1. 打开 `web/index.html` 页面。
2. 在“设置与持久化”面板中使用“导入关卡包（JSON）”按钮，选择包含关卡包的 JSON 文件。
3. 导入成功后提示“下次重开或进入下一关生效”，当前局会按新包重建。
4. 若需要恢复默认推进，可点击“清除关卡包”按钮。

### 小程序端

1. 将关卡包 JSON 文本复制到剪贴板。
2. 在首页点击“导入关卡包”按钮，会自动读取剪贴板并执行校验。
3. 导入成功后会重建当前局，并在提示区展示包名与关卡进度。
4. 点击“清除关卡包”即可移除配置并恢复默认推进。

## 常见错误与排查

* **提示“校验失败”**：检查 JSON 是否缺失必填字段或概率和不为 1。
* **提示“解析失败”**：确保文件/剪贴板内容为合法 JSON 文本，不能包含多余注释。
* **导入后与预期不同**：确认 `size`、`targetFnKey`、`randomTileWeights` 是否填写正确，必要时可在控制台查看警告信息。

## 与设置、存档的关系

* 关卡包通过额外的存储键（Web：`stage2048.levelpack.v1`，小程序：`stage2048.mp.levelpack.v1`）保存，不会影响既有的设置 `stage2048.settings.v2` / `stage2048.mp.settings.v2` 与进度 `stage2048.progress.v2` / `stage2048.mp.progress.v2`。
* 游戏在创建下一关或重建当前关卡实例时，会优先检查关卡包；若索引超出包长度则自动回退到默认的尺寸递增模式。
* 关卡包仅影响“本关实例创建”参数，不会修改已有存档结构，清除后即可恢复原有行为。
