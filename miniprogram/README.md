# 微信小程序版本说明（关卡绘制与本地持久化）

本目录承载微信小程序版实现，当前版本已接入核心关卡逻辑、手势交互，并新增设置与进度的本地持久化能力。

## 导入步骤
1. 打开微信开发者工具，选择“导入项目”。
2. 目录选择本仓库的 `miniprogram/` 文件夹。
3. 将 `project.config.json` 中的 `appid` 替换为你自己的小程序 ID。
4. 点击“导入”后即可在模拟器或真机预览关卡模式。

## 本地持久化与操作
- 设置会保存到 `stage2048.mp.settings.v2`，默认包含格子间隙、起始尺寸、是否累计总分、目标函数标识、固定种子与动画开关。
- 关卡进度（含棋盘状态、累计分与伪随机状态）保存到 `stage2048.mp.progress.v2`，启动时会自动迁移旧版 `*.v1` 数据。
- 最佳分使用独立键 `stage2048.mp.bestScore.v1` 存储，方便单独清空。
- 首页新增“重置进度”按钮，可删除进度存档并按当前设置重新开始。
- 首页新增“清空最佳分”按钮，可立即归零历史最佳成绩并同步 HUD。

## 撤销与复盘
- 上方操作区新增“撤销一步”按钮，成功移动后可立即回到前一状态；演示与复盘期间会自动禁用撤销。
- “重放复盘”按钮会从剪贴板读取 JSON，支持 `{ seed, ops }` 或 `{ replay: { seed, ops } }` 两种结构，导入后会自动重建关卡并按序执行。
- 每场对局都会记录操作序列，导出设置或复盘脚本时会包含 `ops`，配合固定种子可在不同设备精确还原。

## 演示模式
- 操作区新增“演示模式”开关（`switch`），启用后定时尝试四个方向的启发式移动，帮助观察局面。
- 演示会在棋盘无法移动或玩家主动关闭时停止，并调用状态提示与 `wx.showToast` 播报。
- 若正在复盘或棋局结束，演示模式会自动退出以避免冲突。

## 关卡包
- 首页新增“导入关卡包”与“清除关卡包”按钮，对应存储键为 `stage2048.mp.levelpack.v1`，与设置、进度键位保持隔离。
- 点击“导入关卡包”会读取剪贴板 JSON，校验通过后即时写入存储并重建当前关卡，同时在提示区域显示包名与当前索引。
- “清除关卡包”会移除存储并刷新 HUD，恢复默认的尺寸递增推进模式。
- 建议先在 Web 端导入 `web/packs/sample-pack.json` 体验，再复制文本到小程序端；详细格式说明见《[关卡包使用指南](../docs/LEVEL_PACKS_GUIDE.md)》。

## 成就系统
- 程序会记录历史最大方块值（存储于 `stage2048.mp.maxTile.v1`），并在 HUD 下方展示已解锁徽章。
- 达到 64/256/1024 方块时分别授予 🗝️、🎯、🏆，文本与朗读提示会同步更新。
- 徽章信息在撤销、复盘后仍会保留，仅在创下更高方块时追加记录。

## 撤销与复盘脚本导出建议
- Web 端导出的 JSON 可直接复制其中 `replay` 字段文本并粘贴到剪贴板，即可在小程序端使用“重放复盘”导入。
- 若需手动编写脚本，结构示例：`{"seed":"demo","ops":["L","U","R"]}`，注意操作字符需为大写。

## 运行说明
- 通过滑动操作执行上下左右移动；无可用步时会通过 `wx.showToast` 提示。
- 通关后会弹窗询问是否进入下一关，确认后自动晋级。
- 重置进度和清空最佳分操作完成后，会通过 `wx.showToast` 给出结果提示。

## 常见问题与排查
- 小程序端画布、字体或存储异常时，请参考 `/docs/TROUBLESHOOTING.md` 中的小程序章节。
- 若导入 Web 导出的 JSON 失败，请确认字段完整并使用剪贴板方式粘贴，避免因文件格式导致解析失败。
- 真机调试与基础库升级可能影响 `measureText` 行为，建议在排查前阅读文档中的度量差异说明。
